% Test find_step_periods.m


%% Tests without tolerance argument

test_data = { ...
    {[0 0 0 3 3 3 3], 0, 1} {{[4 7]}, 3}; ...
    {[0 0 0 3 3 3 3]', 0, 1} {{[4 7]}, 3}; ...
    {[0 0 0 3 3 3 3], 0, 4} {{[4 7]}, 3}; ...
    {[0 0 0 3 3 3 3], 0, 5} {{}, []}; ...
    {[0 0 0 3 3 3 3], 1, 1} {{[4 7]}, 3}; ...
    {[0 0 0 3 3 3 3], 4, 0} {{[4 7]}, 3}; ...
    {[0 0 0 3 3 3 3], 99, 4} {{[4 7]}, 3}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 1} ...
        {{[2 4], [5 6], [7 10], [11 13]}, [2 -2 3 -3]}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0]', 2, 1} ...
        {{[2 4], [5 6], [7 10], [11 13]}, [2 -2 3 -3]'}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 2} ...
        {{[2 4], [5 6], [7 10], [11 13]}, [2 -2 3 -3]}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 3} ...
        {{[2 4], [7 10], [11 13]}, [2 3 -3]}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 4} {{[7 10]}, 3}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 5} {cell(1, 0), ones(1, 0)}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 3, 1} ...
        {{[2 4], [5 6], [11 13]}, [2 -2 -3]}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 3, 4} ...
        {cell(1, 0), ones(1, 0)} ...
};

for i = 1:size(test_data, 1)
    test_args = test_data{i, 1};
    x = test_args{1};
    n1 = test_args{2};
    n2 = test_args{3};
    [idxs, diffs] = find_step_periods(x, n1, n2);
    test_result = test_data{i, 2};
    assert(isequal(idxs, test_result{1}))
    assert(isequal(diffs, test_result{2}))
end


%% Tests with tolerance argument

test_data = { ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 2, 1.9} {{[2 4], [5 6], [7 10], [11 13]}, [2 -2 3 -3]}; ...
    {[0 2 2 2 0 0 3 3 3 3 0 0 0], 2, 2, 2} {{[7 10], [11 13]}, [3 -3]}; ...
    {[0 -2 -2 -2 0 0 -3 -3 -3 -3 0 0 0], 2, 2, 1.9} {{[2 4], [5 6], [7 10], [11 13]}, [-2 2 -3 3]}; ...
    {[0 -2 -2 -2 0 0 -3 -3 -3 -3 0 0 0], 2, 2, 2} {{[7 10], [11 13]}, [-3 3]}; ...
};

for i = 1:size(test_data, 1)
    test_args = test_data{i, 1};
    x = test_args{1};
    n1 = test_args{2};
    n2 = test_args{3};
    atol = test_args{4};
    [idxs, diffs] = find_step_periods(x, n1, n2, atol);
    test_result = test_data{i, 2};
    assert(isequal(idxs, test_result{1}))
    assert(isequal(diffs, test_result{2}))
end
